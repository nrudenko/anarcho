"use strict";function FocusOn(a){var b=function(a){if(!a.focusOn&&""!=a.focusOn)throw"FocusOnCondition missing attribute to evaluate"};return{restrict:"A",link:function(c,d,e){b(e),c.$watch(e.focusOn,function(b){1==b&&a(function(){d.focus()})})}}}angular.module("anarchoApp",["ngCookies","ngRoute","ui.bootstrap","angularFileUpload","ja.qr","ngClipboard","monospaced.elastic","ngToast"]);var app=angular.module("anarchoApp");app.config(["ngClipProvider",function(a){a.setPath("bower_components/zeroclipboard/dist/ZeroClipboard.swf"),a.setConfig({forceHandCursor:!1})}]),app.config(["$compileProvider",function(a){a.aHrefSanitizationWhitelist(/^\s*(https?|ftp|mailto|chrome-extension|itms-services):/)}]),app.filter("addEllipsis",function(){return function(a,b){var c=b;if(isNaN(parseFloat(c))&&!isFinite(c))throw"addEllipsis wrong attribute to evaluate. Usage: {{ data | addEllipsis : 50}} ";return a?a.length>c?a.substring(0,c).trim()+"...":a:void 0}}),app.constant("AUTH_EVENTS",{loginSuccess:"auth-login-success",loginFailed:"auth-login-failed",logoutSuccess:"auth-logout-success",sessionTimeout:"auth-session-timeout",notAuthenticated:"auth-not-authenticated",notAuthorized:"auth-not-authorized"}),app.config(["$routeProvider",function(a){a.when("/apps",{templateUrl:"views/apps_list.html"}).when("/apps/:app_key",{templateUrl:"views/app_detail.html"}).when("/apps/:app_key/:build_id",{templateUrl:"views/build_details.html"}).when("/settings/:app_key/",{templateUrl:"views/app_settings.html"}).otherwise({redirectTo:"/apps"})}]),app.constant("app_config",{API_URL:"api/"});var AuthCtrl=function(a,b,c,d,e){a.login=function(f){d.login(f).then(function(a){e.create(a.authToken),b.$broadcast(c.loginSuccess)}).catch(function(d){a.error=d.error,b.$broadcast(c.loginFailed)})},a.register=function(f){d.register(f).then(function(a){e.create(a.authToken),b.$broadcast(c.loginSuccess)}).catch(function(d){a.error=d.error,b.$broadcast(c.loginFailed)})},a.logout=function(){e.destroy(),b.$broadcast(c.logoutSuccess)}};app.controller("AuthCtrl",["$scope","$rootScope","AUTH_EVENTS","AuthService","Session",AuthCtrl]),app.controller("TracksCtrl",["$scope","TracksService",function(a,b){a.tracks=[],b.fetch().success(function(b){a.tracks=b.data})}]);var appCtrl=function(a,b,c,d){b.apps=[];var e=function(a,b){a.modalAddApp=function(a){b.close(a)},a.cancel=function(){b.dismiss()}};e.$inject=["$scope","$modalInstance"],b.showNewApp=function(){c.open({templateUrl:"views/new_app_modal.html",size:"sm",controller:e}).result.then(function(a){b.addApp(a)})},a.showLoader(),d.list().success(function(c){b.apps=c.list,a.hideLoader()}),b.addApp=function(a){d.add(a).then(function(a){b.apps.push(a.data)})}};app.controller("AppsCtrl",["$rootScope","$scope","$modal","AppsService",appCtrl]);var appDetailsCtrl=function(a,b,c,d,e,f,g,h,i){h.extend(b),b.app={},b.builds=[],b.appKey=e.app_key,b.progress=-1,b.buildsList=function(a){f.getBuilds(a).then(function(a){b.builds=a.data.list})},b.getApp=function(c){f.get(c).then(function(c){b.app=c.data,b.buildsList(b.appKey),a.hideLoader()})},b.onFileSelect=function(a){var c=a[0];f.uploadBuild(b.appKey,c,function(a){b.progress=a}).then(function(a){b.builds.push(a),b.getApp(b.appKey)}).catch(function(a){i.create({content:a.data.error,className:"danger"})}).finally(function(){d(function(){b.progress=-1},1e3)})},b.showBuildInfo=function(a){g.path("/apps/"+b.app.app_key+"/"+a.id)},b.ids=[],b.remove=function(){f.removeBuilds(b.appKey,b.ids).then(function(){b.ids=[],b.buildsList(b.appKey)})},b.toggleBuild=function(a){var c=b.ids.indexOf(a);c>-1?b.ids.splice(c,1):b.ids.push(a)},a.showLoader(),b.getApp(b.appKey)};app.controller("AppDetailsCtrl",["$rootScope","$scope","$modal","$timeout","$routeParams","AppsService","$location","PermissionService","ngToast",appDetailsCtrl]);var buildDetailsCtrl=function(a,b,c,d,e,f,g){f.extend(b),console.log(g),b.certLink=g.API_URL+"cert",b.app={},b.buildId=c.build_id,b.appKey=c.app_key,b.editNotesDisabled=!0,b.getBuild=function(){d.getBuild(b.appKey,b.buildId).then(function(c){b.build=c.data,a.hideLoader()})},b.editNotes=function(){b.editNotesDisabled=!1},b.linkCopied=function(){e.create("Link "+b.build.build_url+" copied")},b.saveNotes=function(){d.postNotes(b.appKey,b.buildId,b.build.release_notes).then(function(){b.editNotesDisabled=!0},function(){e.create({content:"Can't update release notes",className:"danger"}),console.log()})},a.showLoader(),d.get(b.appKey).then(function(a){b.app=a.data,b.iosApp="ios"===b.app.app_type?!0:!1,b.getBuild()})};app.controller("BuildDetailsCtrl",["$rootScope","$scope","$routeParams","AppsService","ngToast","PermissionService","app_config",buildDetailsCtrl]);var AppSettingsCtrl=function(a,b,c){a.app={},a.appKey=b.app_key,a.canWrite=function(){return a.hasPermission("w")},a.hasPermission=function(b){return a.app.permission?-1!=a.app.permission.indexOf(b):!1},a.getInclude=function(){var b="";switch(a.action){case"team":b="views/settings_team.html";break;case"remove":b="views/settings_remove_app.html";break;case"plugin":b="views/settings_plugin_config.html"}return b},a.getApp=function(b){c.get(b).then(function(b){a.app=b.data,a.action="team"})},a.init=function(){a.getApp(a.appKey)},a.init()};app.controller("AppSettingsCtrl",["$scope","$routeParams","AppsService",AppSettingsCtrl]);var AppRemoveCtrl=function(a,b,c,d){a.removeApp=function(){b.removeApp(a.appKey).then(function(){c.path("#/apps")},function(b){var c=b.data.error,e="You can't remove <b>"+a.app.name+"</b>.  <br> ";"not_enough_permission"===c&&(e+="Not enough permission!"),"app_not_found"===c&&(e+="Application not found!"),d.create({content:e,className:"danger"})})}};app.controller("AppRemoveCtrl",["$scope","AppsService","$location","ngToast",AppRemoveCtrl]);var AppTeamCtrl=function(a,b){a.permissions=[],a.usersList=function(c){b.list(c).success(function(b){a.permissions=b.list})},a.addUser=function(c){c.app_key=a.app.app_key,b.add(c).then(function(b){a.permissions.push(b.data),a.error=null},function(b){a.error=b.data.error})},a.updateUser=function(c){c.app_key=a.app.app_key,b.update(c).success(function(){})},a.revokeUser=function(c){c.app_key=a.app.app_key,b.revoke(c).success(function(b){for(var c=0;c<a.permissions.length;c++)if(a.permissions[c].email===b.email){a.permissions.splice(c,1);break}})},a.usersList(a.app.app_key),a.all_permissions=[{id:"w",name:"Write"},{id:"r",name:"Read"}]};app.controller("AppTeamCtrl",["$scope","SettingsService",AppTeamCtrl]);var AppPluginCtrl=function(a,b){b.getPluginConfig(a.appKey).then(function(b){console.log(b),a.uploadUrl=b.data.uploadUrl,a.apiToken=b.data.apiToken})};app.controller("AppPluginCtrl",["$scope","AppsService",AppPluginCtrl]);var MainCtrl=function(a,b,c,d,e,f,g){a.showLoader=function(){b.progressTimeout=d(function(){b.showProgress=!0},1e3)},a.hideLoader=function(){b.showProgress=!1,d.cancel(b.progressTimeout)},a.isLoading=function(){return b.showProgress},b.loadUser=function(){f.isAuthorized()&&g.getUser().then(function(c){b.currentUser=c,a.hideLoader()}).catch(function(){a.hideLoader()})},b.$on(e.loginSuccess,function(){b.loadUser()}),b.$on(e.logoutSuccess,function(){b.currentUser=null}),b.loadUser()};app.controller("MainCtrl",["$rootScope","$scope","$cookieStore","$timeout","AUTH_EVENTS","Session","AuthService",MainCtrl]);var api=function(a,b,c,d){var e={};return e.getBaseConfig=function(a){var b={url:c.API_URL+a,headers:{}},e=d.authToken;return null!=e&&(b.headers["x-auth-token"]=e),b},e.delete=function(b,c){var d=e.getBaseConfig(b);return d.headers["Content-Type"]="application/json;charset=utf-8",d.method="DELETE",d.data=c,a(d)},e.post=function(b,c){var d=e.getBaseConfig(b);return d.headers["Content-Type"]="application/json;charset=utf-8",d.method="POST",d.data=c,a(d)},e.patch=function(b,c){var d=e.getBaseConfig(b);return d.method="PATCH",d.data=c,a(d)},e.get=function(b){var c=e.getBaseConfig(b);return c.method="GET",a(c)},e.uploadBuild=function(a,c,d,f){var g=e.getBaseConfig(a);return b.upload({url:g.url,method:"POST",headers:g.headers,file:c}).progress(function(a){d(parseInt(100*a.loaded/a.total))}).success(function(a){f(a)})},e};app.factory("Api",["$http","$upload","app_config","Session",api]);var AuthService=function(a){var b={};return b.login=function(b){return a.post("login",b).then(function(a){return a.data},function(a){throw a.data})},b.register=function(b){return a.post("register",b).then(function(a){return a.data},function(a){throw a.data})},b.parseUser=function(a){var b={};return b.name=a.data.name,b.id=a.data.id,b},b.getUser=function(){return a.get("user").then(function(a){return b.parseUser(a)},function(a){throw a})},b};app.factory("AuthService",["Api",AuthService]);var SessionService=function(a){return this.authToken=a.get("auth_token"),this.isAuthorized=function(){return null==this.authToken?!1:!0},this.create=function(b){this.authToken=b,a.put("auth_token",this.authToken)},this.destroy=function(){a.remove("auth_token"),this.authToken=null},this};app.service("Session",["$cookieStore",SessionService]);var AppsService=function(a){var b={};return b.list=function(){return a.get("apps")},b.add=function(b){return a.post("apps",b)},b.removeApp=function(b){return a.delete("apps/"+b)},b.get=function(b){return a.get("apps/"+b)},b.getBuilds=function(b){return a.get("apps/"+b+"/builds")},b.uploadBuild=function(b,c,d,e){return a.uploadBuild("apps/"+b,c,d,e)},b.removeBuilds=function(b,c){return a.delete("apps/"+b+"/builds",{ids:c})},b.getPluginConfig=function(b){return a.get("apps/"+b+"/plugin")},b.getBuild=function(b,c){return a.get("apps/"+b+"/"+c)},b.postNotes=function(b,c,d){return a.post("apps/"+b+"/"+c+"/notes",{release_notes:d})},b};app.factory("AppsService",["Api",AppsService]);var TrackService=function(a,b,c){return{fetch:function(){var d={headers:{"x-auth-token":c.authToken}};return a.get(b.API_URL+"track/list",d)}}};app.factory("TracksService",["$http","configuration","Session",TrackService]);var SettingsService=function(a){var b={};return b.add=function(b){return a.post("permission",b)},b.update=function(b){return a.patch("permission",b)},b.revoke=function(b){return a.delete("permission",b)},b.list=function(b){return a.get("permission/"+b)},b};app.factory("SettingsService",["Api",SettingsService]);var UrlService=function(a){var b={};return b.getBuildUrl=function(b,c){return null!=c.id?a.API_URL+"apps/"+b+"/"+c.id+"/file":void 0},b.getUploadUrl=function(b){return a.API_URL+"apps/"+b},b};app.factory("UrlService",["configuration",UrlService]);var PermissionService=function(){var a={};return a.hasPermission=function(a,b){return a.permission?-1!=a.permission.indexOf(b):!1},a.canWrite=function(b){return a.hasPermission(b,"w")},a.extend=function(b){b.canWrite=function(){return a.canWrite(b.app)}},a};app.factory("PermissionService",[PermissionService]);var IconSrc=function(){var a={};return a.link=function(a,b,c){a.$watch(function(){return c.iconSrc?b.attr("src",c.iconSrc):b.attr("src","images/logo.6db6798c.png"),c.iconSrc},function(a){a||b.attr("src","images/logo.6db6798c.png")}),b.bind("error",function(){b.attr("src","images/logo.6db6798c.png")})},a},OrderBtn=function(){var a={};return a.restrict="E",a.scope=!1,a.link=function(a,b,c){var d=function(){var d="&nbsp;";a.order.field===c.field&&(d=a.order.reverse?"&#9660;":"&#9650;"),b.html("<span>"+c.text+d+"</span>")};b.bind("click",function(){var b=!a.order.reverse;c.field!=a.order.field&&(b=!0),a.$apply(function(){a.order={field:c.field,reverse:b}})}),b.hover(function(){b.css("cursor","hand"),b.css("cursor","pointer")}),a.$watch(function(){return a.order},function(){d()}),void 0!=c.reverse&&null!=c.reverse&&(a.order={field:c.field,reverse:"true"===c.reverse},d())},a};app.directive("iconSrc",IconSrc),app.directive("orderBtn",OrderBtn),app.directive("focusOn",["$timeout",FocusOn]);